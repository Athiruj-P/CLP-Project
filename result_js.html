<head>
  <!-- Load plotly.js into the DOM -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous" />
</head>

<body>
  <h1 class="m-3">Predevelop display stacks</h1>
  <div class="row">
    <div id="graphDiv" class="col-md-9" style="height: 35rem; width: 100%">
      <!-- Plotly chart will be drawn inside this DIV -->
    </div>
    <div class="col-md-3 mt-5 pt-5 pr-0">
      <legend>Stack options</legend>
      <input type="checkbox" checked id="check-all" />
      <span>Check all</span>
      <hr />
      <div id="check-box-area"></div>
    </div>
  </div>
</body>

<!-- Get global variable from another file. (Loading result) -->
<script type="text/javascript" src="json/result.js"></script>

<!-- Global variable and init result data and graph -->
<script>
  colors = [
    "#A61C00",
    "#85200C",
    "#CC0000",
    "#CC4125",
    "#B6630C",
    "#E69138",
    "#FFD966",
    "#93C47D",
    "#38761D",
    "#3D85C6",

    "#6FA8DC",
    "#76A5AF",
    "#76A5AF",
    "#0B5394",
    "#3C78D8",
    "#351C75",
    "#674EA7",
    "#C27BA0",
    "#A64D79",
    "#741B47",
  ]
  class Box {
    // constructor(x, y, z, op = 1, name = "", custom_color = "rgb(0, 0, 255)") {
    // custom_color = "#0000FF"
    constructor(x, y, z, op = 1, name = "", custom_color = "#0000FF") {
      var intensity = [0.6, 0.65, 0.7, 0.75, 0.8, 0.85, 0.9, 0.95, 1];
      var white = "rgb(255, 255, 255)";
      this.data = {
        x: x,
        y: y,
        z: z,
        i: [0, 3, 4, 7, 0, 6, 1, 7, 0, 5, 2, 7],
        j: [1, 2, 5, 6, 2, 4, 3, 5, 4, 1, 6, 3],
        k: [3, 0, 7, 4, 6, 0, 7, 1, 5, 0, 7, 2],
        intensity: intensity,
        colorscale: [
          [0, white],
          [1, custom_color],
        ],
        showscale: false,
        opacity: op,
        flatshading: true, // important
        lighting: {
          facenormalsepsilon: 0, // important
        },
        lightposition: {
          x: 2000,
          y: 1000,
        },
        type: "mesh3d",
        name: name,
      };
    }
  }

  // Array of boxes in a container
  data = [];
  // Set container size
  const obj1 = new Box(
    [0, 30, 0, 30, 0, 30, 0, 30], // => X
    [0, 0, 40, 40, 0, 0, 40, 40], // => Y
    [0, 0, 0, 0, 20, 20, 20, 20], // => Z
    0.2,
    "cube"
  );
  data.push(obj1.data);

  var gd = document.getElementById("graphDiv");

  // Set boxes data
  var number = 1
  Object.entries(total_result).forEach((stacks_obj) => {
    const [key, box_arr] = stacks_obj;
    box_arr.forEach((box) => {
      const obj = new Box(box.x, box.y, box.z, 1, `${key}-${number}`, colors[number % 20]);
      data.push(obj.data);
    });
    $("#check-box-area").append(`
      <input type = "checkbox" checked class = "stack" value = ${key}><span> Stack No. ${number++}</span> <br>
    `);
  });

  // Graph plot
  Plotly.newPlot(gd, {
    data: data,
    layout: { height: $("#graphDiv").height() },
  });
</script>

<script>
  $(document).ready(function () {
    $(".stack").click(function () {
      console.log("click");
      load_data();
    });

    $("#check-all").click(() => {
      var isCheck = $("#check-all").prop("checked")
      if (isCheck) {
        $('.stack:not(:checked)').click()
      } else {
        $('.stack:checked').click()
      }
    });
  });

  window.onresize = function () {
    var new_size = {
      width: $("#graphDiv").width(), // get current window's width
      height: $("#graphDiv").height(), // get current window's height
    };
    // Re-posisioning graph
    Plotly.relayout("graphDiv", new_size);
  };

  function load_data() {
    let stack_name_arr = [];
    $(".stack:checked").each(function () {
      stack_name_arr.push($(this).val());
    });
    let data = [];
    const container = new Box(
      [0, 30, 0, 30, 0, 30, 0, 30],
      [0, 0, 40, 40, 0, 0, 40, 40],
      [0, 0, 0, 0, 20, 20, 20, 20],
      0.2,
      "Cube"
    );
    data.push(container.data);
    number = 1
    stack_name_arr.forEach((stack_name) => {
      total_result[stack_name].forEach((element) => {
        const obj = new Box(element.x, element.y, element.z, 1, `${stack_name}-${number}`, colors[number % 20]);
        data.push(obj.data);
      });
      number++
    });
    gd.data = data;
    Plotly.redraw(gd);
  }
</script>